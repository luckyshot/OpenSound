// Global variables
var audio=document.getElementById("audio"),OpenSound={config:{interval:5,msgtimer:""},msg:function(e,t){"use strict";clearTimeout(this.config.msgtimer);$("#msg").remove();$("body").append('<div id="msg" class="'+t+'"><span id="msg-close" class="close" title="Close">&times;</span><p>'+e+"</p></div>");$("#msg").fadeIn("fastest");$("#msg-close").on("click",function(){$(this).unbind("click");clearTimeout(this.config.msgtimer);$("#msg").fadeOut("fast",function(){$("#msg").remove()})});this.config.msgtimer=setTimeout(function(){$("#msg").fadeOut("slow",function(){$(this).remove()})},7e3)},status:function(){"use strict";var e=(new Date).getTime();$.ajax({url:"status/"+encodeURIComponent(localStorage.devicename)}).done(function(t){console.log(t);localStorage.ping=(new Date).getTime()-e;$("#ping").html(localStorage.ping);audio.src.indexOf(encodeURIComponent(t.song))<0&&(audio.src="file/"+encodeURIComponent(t.song));t.status&&audio.play();if(audio.currentTime<t.pos+2||audio.currentTime>t.pos-2)try{audio.currentTime=t.pos+localStorage.ping/1e3}catch(n){console.log(n)}$("#track").html(t.song);$("#playlist").empty();for(var r in t.playlist)$("#playlist").append("<li>"+t.playlist[r]+"</li>");var i=$("#clients>tbody"),s;i.empty();for(var r=0;r<t.clients.length;r++){s=Math.round((new Date).getTime()/1e3);t.clients[r].name===localStorage.devicename?s="you":s-t.clients[r].lastseen>11?s="offline":s-t.clients[r].lastseen<6?s="online":s="idle";i.append('<tr><td><i class="status '+s+'" title="'+s+'"></i>&nbsp;'+t.clients[r].name+'</td><td><input type="range" class="device-vol" data-devicename="'+t.clients[r].name+'" min="0" max="100" step="1" value="'+t.clients[r].vol+'"></td><td><input type="checkbox" id="device-status-'+r+'" class="device-status" data-devicename="'+t.clients[r].name+'"'+(t.clients[r].status===1?" checked":"")+'><label for="device-status-'+r+'"></label></td></tr>')}})},file:function(e){"use strict";$.ajax({url:"file/"+encodeURIComponent(e)}).done(function(e){console.log(e)})},browse:function(e){"use strict";typeof e=="undefined"&&(e="");$.ajax({url:"browse/"+e}).done(function(t){$("#path").html(e);$("#browser").empty();for(var n in t)$("#browser").append("<li>"+t[n]+"</li>")})},add:function(e){"use strict";$.ajax({url:"add/"+e}).done(function(e){e.status===1?this.status():this.msg(e.msg)})},remove:function(e){"use strict";$.ajax({url:"remove/"+e}).done(function(e){e.status===1?this.status():this.msg(e.msg)})},play:function(e){"use strict";typeof e=="undefined"&&(e="");$.ajax({url:"play/"+e}).done(function(t){audio.src="/file/"+encodeURIComponent(e);$("#track").html(t.song);audio.play()})},pause:function(){"use strict";audio.pause();$.ajax({url:"pause"}).done(function(e){e.status===1?this.status():this.msg(e.msg)})},pos:function(e){"use strict";$.ajax({url:"pos/"+e}).done(function(e){console.log(e)})},name:function(e){"use strict";localStorage.devicename=e},client:function(e,t){"use strict";$.ajax({url:"client/"+e+"/"+t}).done(function(e){console.log(e)})},clientvol:function(e,t){"use strict";$.ajax({url:"client/"+e+"/vol/"+t}).done(function(e){console.log(e)})},delay:function(e,t){typeof t=="undefined"&&(t=500);setTimeout(function(){e()},t)},nextSong:function(){var e=[];$("#playlist>li").each(function(){e.push($(this).text())});for(var t=0;t<e.length;t++){console.log($("#track").html()+"-"+e[t]);if($("#track").html()===e[t]){OpenSound.play(e[t+1]);break}}}};$(audio).bind("ended",function(){OpenSound.nextSong()});$("#playlist").on("click","li",function(){OpenSound.play(encodeURIComponent($(this).html()))});$("#browser").on("click","li",function(){$(this).html().indexOf(".mp3")>0?OpenSound.add($("#path").html()+$(this).html()):OpenSound.browse(encodeURIComponent($(this).html()))});$("#clients").on("mouseup","input.device-vol",function(){$(this).data("devicename")===localStorage.devicename&&(document.getElementById("audio").volume=$(this).val()/100);$.ajax({url:"clientvol/"+encodeURIComponent($(this).data("devicename"))+"/"+$(this).val()}).done(function(e){console.log(e)})});$("#clients").on("change","input.device-status",function(){$.ajax({url:"clientstatus/"+encodeURIComponent($(this).data("devicename"))+"/"+($(this).prop("checked")?1:0)}).done(function(e){console.log(e)})});$("#devicename").on("blur",function(){OpenSound.name($(this).val())});$("#play").on("click",function(){OpenSound.play($("#track").html())});$("#pause").on("click",function(){OpenSound.pause()});$(document).ready(function(){typeof localStorage.devicename=="undefined"&&(localStorage.devicename="device-"+Math.floor(Math.random()*999+100));$("#devicename").val(localStorage.devicename);OpenSound.browse("");OpenSound.status();setInterval(function(){OpenSound.status()},OpenSound.config.interval*1e3)});